# SolidStack Node Registry

This directory contains the **registry** - the source of truth for what infrastructure exists in the SolidStack system.

## Purpose

The registry answers these questions:
* **What nodes exist?** (SRV, SSDC, SSDOCK, etc.)
* **What services run where?** (Traefik on SSDOCK, etc.)
* **How do nodes relate?** (SSDOCK depends on SSDC for DNS, etc.)
* **How do I access nodes?** (IP addresses, SSH config)

## Files

### `nodes.yaml`
Defines all infrastructure nodes (physical servers, VMs).

**Contains:**
* Node name, type, and tier
* Platform (Windows/Linux) and OS version
* IP addresses (local and Tailscale)
* SSH access information
* Capabilities (what the node can do)
* Services (what runs on the node)
* Deployment metadata (when, by whom)

### `services.yaml`
Defines all services and applications.

**Contains:**
* Service name and type
* Which node it runs on
* Container image and version
* Configuration requirements
* Dependencies (what it needs to run)
* Health check information

### `relationships.yaml`
Defines dependencies and trust relationships.

**Contains:**
* Service → Service dependencies
* Node → Node dependencies
* Trust boundaries
* Data flow paths

### `ssh-config.d/`
Auto-generated SSH config fragments.

**Contains:**
* One `.conf` file per node
* Generated by `solidstack-deploy.ps1` during bootstrap
* Merged into operator's `~/.ssh/config`

## Design Principles

### 1. Document Reality, Not Intention
The registry reflects what **actually exists**, not what you plan to build. If a node isn't deployed yet, it's not in the registry (or marked as `deployed: false`).

### 2. Git is the Source of Truth
The registry lives in Git. Changes are committed and pushed. Git history is the audit trail.

### 3. Nodes Update Their Own Entries
When `solidstack-deploy.ps1` runs on a node, it updates the registry with current state (SSH fingerprint, capabilities, etc.) and commits the change.

### 4. Human-Readable Format
YAML is used because:
* It's human-readable and editable
* It's machine-parseable
* It's well-supported in PowerShell (`ConvertFrom-Yaml`)
* It's version-control friendly

## Workflow

### Adding a New Node

1. **Create the VM/server** (manual or scripted)
2. **Run `solidstack-deploy.ps1`** on the new node
3. **Registry is updated automatically** with node details
4. **SSH config is generated** in `ssh-config.d/`
5. **Changes are committed** to Git
6. **Operator pulls changes** on their Mac

### Updating a Node

1. **Make changes** (install software, deploy service, etc.)
2. **Run `solidstack-deploy.ps1 -Realign`**
3. **Registry is updated** with new state
4. **Changes are committed** to Git

### Querying the Registry

```powershell
# Get all nodes
$nodes = Get-Content registry/nodes.yaml | ConvertFrom-Yaml

# Find execution platforms
$execNodes = $nodes.nodes.GetEnumerator() | 
    Where-Object { $_.Value.type -eq 'execution-platform' }

# Get services on SSDOCK
$ssdockServices = $nodes.nodes.SSDOCK.services
```

## Future Evolution

### Phase 1 (Current)
* Git-based YAML files
* Manual commits after deployment
* Static registry

### Phase 2 (Future)
* API endpoint for dynamic updates
* Nodes report health/status in real-time
* `Get-SolidStackStatus.ps1` queries API
* Git remains source of truth for configuration
* Runtime state stored separately

## Example Usage

```powershell
# On Mac: Update SSH config from registry
cd ~/projects/solidstack
git pull
./scripts/update-ssh-config.sh

# Now you can access any node
ssh ssdock

# On any node: Realign with current state
pwsh ./solidstack-deploy.ps1 -Realign
git pull  # Get latest registry
git push  # Push updated state
```

## See Also

* `nodes.yaml` - Node definitions
* `services.yaml` - Service definitions
* `relationships.yaml` - Dependencies
* `/docs/PRINCIPLES.md` - Design philosophy
* `/docs/INFRASTRUCTURE.md` - Infrastructure overview
